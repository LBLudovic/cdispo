<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Établissements</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<link rel="stylesheet" href="assets/app.css"/>
</head>
<body data-page="list">
<div class="app">
  <header>
    <div class="row">
      <div>
        <div class="title">Établissements</div>
        <div class="sub"><i class="fa-solid fa-location-dot"></i> Montpellier</div>
      </div>
      <a class="btn icon" href="map.html" aria-label="Carte"><i class="fa-solid fa-map"></i></a>
    </div>

    <div class="toolbar">
      <div class="select-pill" aria-label="Tri">
        <i class="fa-solid fa-arrow-up-short-wide"></i>
        <select id="sortSelect">
          <option value="distance" selected>Proche</option>
          <option value="rating">Mieux notés</option>
          <option value="trend">Tendance</option>
        </select>
      </div>
      <button class="btn" type="button" id="openFilters"><i class="fa-solid fa-sliders"></i> Filtres</button>
    </div>
  </header>

  <main>
    <div class="cards" id="cards"></div>
  </main>

  <nav class="bottom" aria-label="Navigation principale">
  <a href="home.html" data-page="home" class=""><i class="fa-solid fa-house"></i><span>Accueil</span></a>
  <a href="map.html" data-page="map" class=""><i class="fa-solid fa-map"></i><span>Carte</span></a>
  <a href="list.html" data-page="list" class="active"><i class="fa-solid fa-utensils"></i><span>Étab.</span></a>
  <a href="account.html" data-page="account" class=""><i class="fa-solid fa-user"></i><span>Compte</span></a>
</nav>
</div>

<div class="toast" id="toast">Action</div>

<div class="sheet-backdrop" id="filters-backdrop"></div>
<section class="sheet" id="filters" aria-label="Filtres">
  <div class="handle"></div>
  <div class="sheet-header">
    <div class="sheet-title">Filtres</div>
    <button class="btn icon ghost" type="button" data-close-sheet="filters" aria-label="Fermer"><i class="fa-solid fa-xmark"></i></button>
  </div>

  <div class="field">
    <label>Type</label>
    <select id="filterType">
      <option value="all" selected>Tous</option>
      <option value="Cocktail Bar">Cocktail bar</option>
      <option value="Resto-bar">Resto-bar</option>
      <option value="Brasserie">Brasserie</option>
      <option value="Wine bar">Wine bar</option>
      <option value="Tapas / Cocktails">Tapas / Cocktails</option>
      <option value="Food & Drinks">Food & Drinks</option>
    </select>
  </div>

  <div class="field">
    <label>Distance max (km)</label>
    <input type="range" min="1" max="6" step="0.5" value="6" id="filterMaxDist"/>
  </div>

  <div class="field">
    <label>Note minimum</label>
    <input type="range" min="3.5" max="5" step="0.1" value="3.5" id="filterMinRating"/>
  </div>

  <div class="field">
    <label>Attente max (min)</label>
    <input type="range" min="0" max="45" step="5" value="45" id="filterMaxWait"/>
  </div>

  <div class="toggle">
    <div>
      <div style="font-weight:850;">Seulement dispo</div>
      <div style="font-size:12px; color:var(--muted);">Places disponibles</div>
    </div>
    <input type="checkbox" id="filterOnlyAvail"/>
  </div>

  <div style="display:flex; gap:10px; margin-top:14px;">
    <button class="btn" type="button" id="resetFilters" style="flex:1;">Réinitialiser</button>
    <button class="btn primary" type="button" id="applyFilters" style="flex:1;">Appliquer</button>
  </div>
</section>

<script src="assets/data.js"></script>
<script src="assets/app.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  wireSheet('filters');
  document.getElementById('openFilters').addEventListener('click', ()=>openSheet('filters'));

  const ESTS = window.APP_DATA.establishments;

  const state = {
    sort: "distance",
    type: "all",
    maxDist: 6,
    minRating: 3.5,
    maxWait: 45,
    onlyAvail: false
  };

  function applySort(arr){
    const a = [...arr];
    if(state.sort === "distance") a.sort((x,y)=>x.distanceKm - y.distanceKm);
    if(state.sort === "rating") a.sort((x,y)=>y.rating - x.rating);
    if(state.sort === "trend") a.sort((x,y)=>y.trend - x.trend);
    return a;
  }

  function applyFilters(arr){
    return arr.filter(e=>{
      if(state.type !== "all" && e.type !== state.type) return false;
      if(e.distanceKm > state.maxDist) return false;
      if(e.rating < state.minRating) return false;
      if(state.onlyAvail && e.spots <= 0) return false;
      if(e.spots <= 0 && e.waitMin > state.maxWait) return false;
      return true;
    });
  }

  function cardHTML(e){
    const w = waitInfo(e);
    const img = estImageUrl(e);
    return `
      <a class="card" href="establishment.html?id=${e.id}" style="text-decoration:none;">
        <div class="card-top" style="background-image:url('${img}');">
          <div class="pill"><i class="fa-solid fa-star"></i> ${e.rating}</div>
          <div class="status"><span style="width:8px;height:8px;border-radius:99px;background:${w.color};display:inline-block;"></span>${w.label}</div>
        </div>
        <div class="card-body">
          <div class="card-head">
            <h3 class="name">${e.name}</h3>
            <span class="rating"><i class="fa-solid fa-location-dot"></i> ${e.distanceKm.toFixed(1)} km</span>
          </div>
          <div class="meta">
            <span><i class="fa-solid fa-martini-glass-citrus"></i> ${e.type}</span>
            <span><i class="fa-solid fa-map-pin"></i> ${e.area}</span>
            <span><i class="fa-solid fa-arrow-trend-up"></i> ${e.trend}</span>
          </div>
          <div class="card-actions">
            <button class="fav" type="button" data-fav aria-label="Favori"><i class="fa-regular fa-heart"></i></button>
            <span class="btn small primary" style="flex:1; text-align:center; pointer-events:none;">Voir détails</span>
          </div>
        </div>
      </a>
    `;
  }

  function render(){
    const list = applySort(applyFilters(ESTS));
    const root = document.getElementById('cards');
    root.innerHTML = list.map(cardHTML).join('') || `
      <div class="card" style="padding:16px; color:var(--muted);">Aucun résultat</div>
    `;
    // re-wire fav buttons inside cards
    root.querySelectorAll('[data-fav]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        toggleFav(btn);
      });
    });
  }

  // Sort
  document.getElementById('sortSelect').addEventListener('change',(e)=>{
    state.sort = e.target.value;
    render();
  });

  function syncUI(){
    document.getElementById('filterType').value = state.type;
    document.getElementById('filterMaxDist').value = state.maxDist;
    document.getElementById('filterMinRating').value = state.minRating;
    document.getElementById('filterMaxWait').value = state.maxWait;
    document.getElementById('filterOnlyAvail').checked = state.onlyAvail;
  }
  syncUI();

  document.getElementById('resetFilters').addEventListener('click', ()=>{
    state.type="all"; state.maxDist=6; state.minRating=3.5; state.maxWait=45; state.onlyAvail=false;
    syncUI(); render();
    showToast("Filtres réinitialisés");
  });

  document.getElementById('applyFilters').addEventListener('click', ()=>{
    state.type = document.getElementById('filterType').value;
    state.maxDist = parseFloat(document.getElementById('filterMaxDist').value);
    state.minRating = parseFloat(document.getElementById('filterMinRating').value);
    state.maxWait = parseInt(document.getElementById('filterMaxWait').value,10);
    state.onlyAvail = document.getElementById('filterOnlyAvail').checked;
    closeSheet('filters');
    render();
    showToast("Filtres appliqués");
  });

  render();
});
</script>
</body>
</html>
